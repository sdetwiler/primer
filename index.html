<!DOCTYPE html>
<html lang="en" dir="ltr" class="client-nojs">
<head>
<meta charset="UTF-8" />
<title>Primer</title>
<meta name="generator" content="MediaWiki 1.26wmf10" />
<link rel="copyright" href="//creativecommons.org/licenses/by-sa/3.0/" />
<link rel="stylesheet" href="//en.wikipedia.org/w/load.php?debug=false&amp;lang=en&amp;modules=ext.uls.nojs%7Cext.visualEditor.viewPageTarget.noscript%7Cext.wikihiero%7Cmediawiki.legacy.commonPrint%2Cshared%7Cmediawiki.sectionAnchor%7Cmediawiki.skinning.interface%7Cmediawiki.ui.button%7Cskins.vector.styles%7Cwikibase.client.init&amp;only=styles&amp;skin=vector&amp;*" />
<meta name="ResourceLoaderDynamicStyles" content="" />
<link rel="stylesheet" href="//en.wikipedia.org/w/load.php?debug=false&amp;lang=en&amp;modules=site&amp;only=styles&amp;skin=vector&amp;*" />
<style>a:lang(ar),a:lang(kk-arab),a:lang(mzn),a:lang(ps),a:lang(ur){text-decoration:none}
/* cache key: enwiki:resourceloader:filter:minify-css:7:3904d24a08aa08f6a68dc338f9be277e */</style>
<!--[if lt IE 7]><style type="text/css">body{behavior:url("/w/static/1.26wmf10/skins/Vector/csshover.min.htc")}</style><![endif]-->
	
	<style>
	#nav
	{
		display:none;
	}
	
	#spinner
	{
		display:none
	}
	
	#image
	{
/*		max-width:100%;*/
		max-height:600px;
	}
	
	</style>
	
	<script>
	
	function chunkText(text)
	{
		var maxLen = 200;
		var chunks = [];
		// if(text.length > maxLen)
		// {
			var sentences = text.split(".");
			for(var si in sentences)
			{
				var s = sentences[si];
				while(s.length > maxLen)
				{
					var idx = s.lastIndexOf(" ", maxLen);
					if(idx < 0)
					{
						// just hack it up.
						var left = s.substr(0,maxLen);
						s = s.substr(maxLen);
						chunks.push(left);
					}
					else
					{
						var left = s.substr(0, idx)
						s = s.substr(idx);
						chunks.push(left);
					}
				}
				chunks.push(s)
			}
		// }
		// else
		// {
		// 	chunks.push(text);
		// }

		return chunks;
	}

	var media = {};
	function addMedia(mediaItem, chunkId)
	{
		console.log("addMedia " + chunkId + " " + mediaItem.url)
		media[chunkId] = mediaItem;
	}
	
	function nextChunk(chunkId)
	{
		var image = document.getElementById("image");
		var vector = document.getElementById("vector");
		console.log("nextChunk:" + chunkId);
		if(chunkId in media)
		{
			med = media[chunkId]
			console.log(med)
			switch(med.contentType)
			{
				case "image/jpeg":
				case "image/png":
				case "image/gif":
				case "image/svg+xml":
					image.src = med.url;
					break;
			}
		}
	}

	var gChunks = [];
	var gCurrChunk = -1;
	

	function goPrevious()
	{
		skipping = true;
		window.speechSynthesis.cancel();
		gCurrChunk-=2;
		if(gCurrChunk < 0)
		{
			gCurrChunk = 0;
		}
		
		playNextChunk();
	}

	function goNext()
	{
		skipping = true;
		gCurrChunk--;
		window.speechSynthesis.cancel();
		playNextChunk();
	}
	
	function goPlayPause()
	{
		var button = document.getElementById("playpause");
		
		if(window.speechSynthesis.speaking)
		{
			window.speechSynthesis.pause();
			playpause.value=">";
		}
		else //if(window.speechSynthesis.paused)
		{
			window.speechSynthesis.play();
			playpause.value="||";
		}
	}
	
	function playNextChunk()
	{
		if(gCurrChunk < gChunks.length)
		{
			++gCurrChunk;
			skipping = false;
			
			var msg = new SpeechSynthesisUtterance(gChunks[gCurrChunk]);
			msg.chunkId = gCurrChunk;

			msg.addEventListener("start", function(){
				console.log("start");
				nextChunk(this.chunkId);
			}.bind(msg));

			msg.addEventListener("end", function(){
				console.log("end");
				if(skipping != true)
				{
					playNextChunk();
				}
			}.bind(msg));

			// Hack to get speech synth to work reliably... seriously.
			// https://code.google.com/p/chromium/issues/detail?id=335907
			console.log(msg);
			window.speechSynthesis.speak(msg);
			
		}
	}

	function play(article)
	{
		var heading = document.getElementById("firstHeading");
		heading.innerHTML = article.title;
		var sourceLink = document.getElementById("sourceLink");
		sourceLink.href = article.url;
		var chunkId = 0;
		console.log("play:" + article.title);

		window.speechSynthesis.pause();
		window.speechSynthesis.cancel();
		
		for(var i=0; i<article.content.length; ++i)
		{
			var curr = article.content[i];
			var mediaIdx = 0;
			
			// If a media item exists grab it for the chunk id. This could be overridden later
			// but exists in case there are chunks with no text.
			if(curr.media.length > 0)
			{
				addMedia(curr.media[0], chunkId);
			}
			
			// Now chunk the text into sentences and assign up to one media item per sentence.
			var chunks = chunkText(article.content[i].text);
			console.log(chunks.length + " text chunks")
			for(var c=0; c<chunks.length; ++c)
			{
				// console.log("  " + c + ": " + chunks[c]);
				// console.log(curr.media.length + " media items")
				if(mediaIdx < curr.media.length)
				{
					addMedia(curr.media[mediaIdx], chunkId);
					++mediaIdx;
				}

				++chunkId;
			}
			gChunks = gChunks.concat(chunks);
			gCurrChunk = -1;
		}
		
		playNextChunk();
	}
	
	
	function init()
	{
		window.speechSynthesis.pause();
		window.speechSynthesis.cancel();
	}
	
	function search()
	{
		var f = document.getElementById("f");
		var spinner = document.getElementById("spinner");

		var q = document.getElementById("q");
		f.style.display = "none";
		spinner.style.display = "block";

		var req = new XMLHttpRequest();
		req.onload = function() {
			console.log("onload");
			json = JSON.parse(this.responseText);
			
			spinner.style.display = "none";
			var nav = document.getElementById("nav");
			nav.style.display = "block";
			
			play(json);
//			Hand built test dataset.
			// play(wwi);
		}
		
		var query = q.value.replace(" ", "_");
		req.open("GET", query, true);
		req.send();
		
		
		return false;
	}
	</script>





</head>
<body class="mediawiki ltr sitedir-ltr ns-0 ns-subject page-Pioneer_11 skin-vector action-view" onload="init()">
		<div id="mw-page-base" class="noprint"></div>
		<div id="mw-head-base" class="noprint"></div>
		<div id="content" class="mw-body" role="main">
			<a id="top"></a>
			<div id="siteNotice"><!-- CentralNotice --></div>
			<div class="mw-indicators"></div>
			<h1 id="firstHeading" class="firstHeading" lang="en"><i>Primer</i></h1>
			<div id="bodyContent" class="mw-body-content">
				<div id="siteSub"><a id="sourceLink" href="#">From Wikipedia, the free encyclopedia</a></div>
				<div id="contentSub"></div>
				<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr">
					<p>
<form onsubmit="return search()" id="f">
	Name a topic: <input type="text" id="q">
</form>
<img id="spinner" src="/assets/spinner.gif">
<div id="nav">
<input type="button" onclick="goPrevious()" value="&lt;&lt;">
<input type="button" onclick="goNext()" value="&gt;&gt;">
<input type="button" id="playpause" onclick="goPlayPause()" value="||">
</div>
						<img id="image">
						
					</p>
			</div>
		</div>
	</body>
</html>
