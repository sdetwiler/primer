<!DOCTYPE html>
<html class="full" lang="en" id="image">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>The Primer</title>

		<!-- Latest compiled and minified CSS -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

    <!-- Custom styles for this template -->
    <link href="/assets/cover.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

		<style>
		
		body 
		{
			background:none;
			margin:0;
			padding:0;
		}

		.full 
		{
		  width:100%;
		  height:100%;
		  min-height:100%;
		  background-repeat:no-repeat;
		  background-position:50% 50%;
		  background-position:50% 50%\9 !important;
		  overflow:hidden;
		  position:absolute;
		}
		
			#content
			{
				display:none;
			}
			#cover
			{
				display:none;
				background-color:rgba(0,0,0,0.4);
				height:100%;
				margin:0;
				padding:0;
			}
			#loading
			{
				display:none;
			}
			#caption
			{
				cursor:pointer;
			}
			#playControls
			{
				display:none;
			}
			#scrubberHandle
			{
				padding-top:5px;
				text-size:30px;
			}
			
			footer 
			{
			  position: absolute;
			  bottom: 0px;
			  width: 100%;
			/*  height: 60px;*/
				color:#ffffff;
			}

			.recommendation
			{
				cursor:pointer;
				font-weight:bold;
			}

			.scrubber-bg
			{
			  height: 30px;
			  background-color: rgba(0,0,0,0.8);
			}

			.scrubber-progress
			{
			  height: 30px;
			  background-color: rgba(255,0,0,1.0);
				width:0%;
				text-align:right;
				font-size:20px;
			}

			.playback-controls
			{
				font-size:30px;
	
			}

			.playback-controls-container
			{
			  height: 40px;
				padding-left:10px;
			  background-color: rgba(0,0,0,0.8);
				text-align:left;
			}

			.caption-container
			{
				padding-right:20px;
			  background-color: rgba(0,0,0,0.5);
				text-align:right;
				font-size:40px;
			}
			
			.header-info
			{
			  background-color: rgba(0,0,0,0.5);
			}
			
		</style>

		<script>
		  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		  ga('create', 'UA-56973498-2', 'auto');
		  ga('send', 'pageview');

		</script>

			<script>
			//-------------------------------------------------------------------------
			// Someday these should be moved out of the global scope.
			//-------------------------------------------------------------------------
			var gCover;						// Cover home screen DOM element.
			var gContent;					// Article content DOM element.
			var gLoading;					// Loading screen DOM element.
			var gQuery;						// Query string input DOM element.
			var gImage;						// Article image DOM element.
			var gText;						// Current article text chunk.
			var gCaption;					// Media caption DOM element.
			var gTitle;						// Article title DOM element.
			var gPlayControls; 		// Playback controls container DOM element.
			var gScrubberProgress;// Playback scrubber progress bar DOM element.
			var gScrubberHandle;	// Playback scrubber progress bar handle DOM element.
			var gLoadingHeading;
			var gRecommendation;	// Text for random recommendation on home screen.
			
			var gScrubbing = false; // Is the user scrubbing.

			var gDebug = null;		// Debug text DOM element.
			
			var gChunks = [];			// All text chunks for the current article.
			var gCurrChunk = -1;	// ID of the currently playing chunk.
			var gMedia = {};			// All media to display, indexed by chunk id.
			var gPlaying = false;	// Has playback begun?
			
			//-------------------------------------------------------------------------
			// Constructor when page loads.
			//-------------------------------------------------------------------------
			function init()
			{
				gCover = document.getElementById("cover");
				gContent = document.getElementById("content");
				gLoading = document.getElementById("loading");
				gQuery = document.getElementById("query");
				gImage = document.getElementById("image");
				gText = document.getElementById("currText");
				gCaption = document.getElementById("caption");
				gTitle = document.getElementById("title");
				gRecommendation = document.getElementById("randomRecommendation");
				
				
				gPlayControls = document.getElementById("playControls");
				gScrubberProgress = document.getElementById("scrubberProgress");
				gScrubberHandle = document.getElementById("scrubberHandle");
				
				gLoadingHeading = document.getElementById("loadingHeading");
				//gDebug = document.getElementById("debug");

				syncNav();
			}
			
			function syncNav()
			{
				if(location.pathname == "/")
				{
					doHome();
				}
				else
				{
					
					var tokens = location.pathname.split("/")
					var query = tokens[tokens.length-1];
					search(query);
				}
			}

			function updateHistory(path)
			{
				if(location.pathname != path)
				{
					history.pushState(null,null, path);
				}
			}
			
			function onPopState()
			{
				console.log("onPopState: " + location.pathname);
				syncNav();
			}
			window.onpopstate = this.onPopState.bind(this);
			
			
			//-------------------------------------------------------------------------
			// Reset to the search screen.
			//-------------------------------------------------------------------------
			function reset()
			{
				log("reset");

				window.speechSynthesis.pause();
				window.speechSynthesis.cancel();
				
				gChunks = [];
				gCurrChunk = -1;
				gMedia = {};
				gPlaying = false;
				gRecommendation.innerHTML = "";
			}
			
			//-------------------------------------------------------------------------
			// Go to the home screen.
			//-------------------------------------------------------------------------
			function doHome()
			{
				log("doHome");

				updateHistory("/");

				reset();

				gImage.style["background-image"] = "";

				gQuery.value = "";
				gCover.style.display="block";
				gContent.style.display="none";
				gLoading.style.display="none";
				gPlayControls.style.display="none";
				
				randomBackground();
			}
			
			function randomBackground()
			{
				var req = new XMLHttpRequest();
				req.onload = function() {
					log("randomBackground.onload");
					json = JSON.parse(this.responseText);
					showMedia(json);
					
					var article = json["article"][0];
					article = article.split("_").join(" ");
					gRecommendation.innerHTML = article;
				}
				req.open("GET", "/r/", true);
				req.send();
			}
			
			//-------------------------------------------------------------------------
			// Kick off an article search using the current query from the UI.
			//-------------------------------------------------------------------------
			function doSearch()
			{
				log("doSearch");
				
				search(gQuery.value);
				return false;
			}
			
			//-------------------------------------------------------------------------
			// Search for the article matching the specified query and then play it.
			//-------------------------------------------------------------------------
			function search(query)
			{
				reset();
				query = query.replace(" ", "_").replace("%20", "_");
				
				updateHistory("/a/" + query);

				gImage.style["background-image"] = "";
				gCover.style.display="none";
				gContent.style.display="none";
				gLoading.style.display="block";
				gPlayControls.style.display="none";

				gLoadingHeading.innerHTML = "Building Article for " + query;
				var req = new XMLHttpRequest();
				req.onload = function() {
					log("doSearch.onload");
					json = JSON.parse(this.responseText);
			
					playArticle(json);
				}
		
				req.open("GET", "/d/"+query, true);
				req.send();

				return false;
			}
			
			function populate(evt)
			{
				gQuery.value = evt.target.innerHTML;
				doSearch();
			}
				
			
			
			//-------------------------------------------------------------------------
			// Play the specified article.
			//-------------------------------------------------------------------------
			function playArticle(article)
			{
				gTitle.innerHTML = decodeURIComponent(article.title).replace("_", " ");
				gTitle.href = article.url;
				var chunkId = 0;
				log("doPlay:" + article.title);

				if(article.content.length && (article.content[0].text.indexOf("REDIRECT")==0))
				{
					var redirect = article.content[0].text.substr(9);
					search(redirect);
					return;
				}

				for(var i=0; i<article.content.length; ++i)
				{
					var curr = article.content[i];
					var mediaIdx = 0;
			
					// If a media item exists grab it for the chunk id. This could be overridden later
					// but exists in case there are chunks with no text.
					if(curr.media.length > 0)
					{
						addMedia(curr.media[0], chunkId);
					}
			
					// Now chunk the text into sentences and assign up to one media item per sentence.
					var chunks = chunkText(article.content[i].text);
					log(chunks.length + " text chunks")
					for(var c=0; c<chunks.length; ++c)
					{
						// log("  " + c + ": " + chunks[c]);
						// log(curr.media.length + " media items")
						if(mediaIdx < curr.media.length)
						{
							addMedia(curr.media[mediaIdx], chunkId);
							++mediaIdx;
						}

						++chunkId;
					}
					
					gChunks = gChunks.concat(chunks);
					gCurrChunk = -1;
				}
				var iOS = ( navigator.userAgent.match(/iPad|iPhone|iPod/g) ? true : false );
				if(!iOS)
				{
					playNextChunk();
				}
								
				gCover.style.display="none";
				gContent.style.display="block";
				gLoading.style.display="none";
				gPlayControls.style.display="block";				
			}
			
			
			//-------------------------------------------------------------------------
			// Chunk the input text into an array of strings that can be processed by
			// speech synthesis. There are many bugs in speech synthesis for long strings
			// and too many strings at once, so this tries to avoid it.
			//
			// Also, this syncs sentences to individual media items.
			//-------------------------------------------------------------------------
			function chunkText(text)
			{
				var maxLen = 200;
				var chunks = [];
				var sentences = text.split(". ");
				for(var si in sentences)
				{
					var s = sentences[si];
					while(s.length > maxLen)
					{
						var idx = s.lastIndexOf(" ", maxLen);
						if(idx < 0)
						{
							// just hack it up.
							var left = s.substr(0,maxLen);
							s = s.substr(maxLen);
							chunks.push(left);
						}
						else
						{
							var left = s.substr(0, idx)
							s = s.substr(idx);
							chunks.push(left);
						}
					}
					chunks.push(s)
				}
				return chunks;
			}
			
			function log(msg)
			{
				console.log(msg);
				if(gDebug)
				{
					gDebug.innerHTML = msg;
				}
			}

			//-------------------------------------------------------------------------
			// Add media to display at the specified chunkId
			//-------------------------------------------------------------------------
			function addMedia(mediaItem, chunkId)
			{
				log("addMedia " + chunkId + " " + mediaItem.url)
				gMedia[chunkId] = mediaItem;
			}
	
			//-------------------------------------------------------------------------
			// Show the media paired for the specified chunk, if it exists.
			//-------------------------------------------------------------------------
			gPendingImages = {};
			
			function cancelPendingImages()
			{
				for(i in gPendingImages)
				{
					var img = gPendingImages[i];
					img.src = "";
				}
				gPendingImages = {};
			}
			
			function onImageReady()
			{
				console.log("loaded " + this.src);
				if(this.src in gPendingImages)
				{
					delete gPendingImages[this.src];
				}
				gImage.setAttribute("sourceWidth", this.width);
				gImage.setAttribute("sourceHeight", this.height);
				gImage.style["background-image"] = "url('" + this.src + "')";
				resizeFullscreen();
			}
			
			function onImageError()
			{
				console.log("Error loading " + this.src);
				var patched = this.src.replace("commons", "en");
				// If the URL changed, try the patched url.
				if(patched != this.src)
				{
					console.log("loading patched " + this.src);
					this.src = patched;
				}
			}
			
			function showMedia(med)
			{
				log(med);
					switch(med.contentType)
					{
						case "image/jpeg":
						case "image/png":
						case "image/gif":
						case "image/svg+xml":
							cancelPendingImages();
//							gImage.style["background-image"] = "url('" + med.url + "')";
							var img = document.createElement("IMG");
							gPendingImages[med.url] = img;
							img.onload = onImageReady.bind(img);
							img.onerror = onImageError.bind(img);
							
							console.log("loading " + med.url);
							img.src = med.url;
							
							gCaption.innerHTML = med.caption;
							gCaption.article = med.article;
							break;
						default:
							log("failed to showMediaForChunk " + med.contentType + " " + med.url);
					}
			}
			
			function showMediaForChunk(chunkId)
			{
				
				log("showMediaForChunk:" + chunkId);
				if(chunkId in gMedia)
				{
					log("will showMediaForChunk:" + chunkId);
					if(gMedia[chunkId][0] !== undefined)
					{
						med = gMedia[chunkId][0];
					}
					else
					{
						med = gMedia[chunkId];
					}
					console.log(med);
					showMedia(med);
					// log(med)
				}
			}
			
			function onScrubStart()
			{
				// log("onScrubStart: " + gScrubberHandle.offsetLeft + " " + gScrubberHandle.offsetTop);
				gScrubbing = true;
			}
			function onScrub(ev)
			{
				if(gScrubbing)
				{
					window.speechSynthesis.cancel();
					// log("onScrub: " + gScrubberHandle.offsetLeft + " " + gScrubberHandle.offsetTop + " " + window.innerWidth);
				
					var pct = parseInt((ev.clientX / window.innerWidth)*100);
					setScrubberPercentage(pct);

					var chunkId = parseInt((ev.clientX / window.innerWidth) * gChunks.length);
					showMediaForChunk(chunkId);
				}
			}
			function onScrubEnd(ev)
			{
				if(gScrubbing)
				{
					// log("onScrubEnd: " + gScrubberHandle.offsetLeft + " " + gScrubberHandle.offsetTop);
					gScrubbing = false;
					
					gCurrChunk = parseInt((ev.clientX / window.innerWidth) * gChunks.length);
					playNextChunk();
				}
			}
	
			function setScrubberPercentage(pct)
			{
				// log("setScrubberPercentage: " + gCurrChunk + " " + gChunks.length + " " + pct);
				gScrubberProgress.style["width"] = pct + "%";
			}
	
	
	
			function resizeFullscreen()
			{
				if(gImage)
				{
	        var currWidth = gImage.offsetWidth;
	        var currHeight = gImage.offsetHeight;
	        var imgWidth = parseInt(gImage.getAttribute("sourceWidth"));
	        var imgHeight = parseInt(gImage.getAttribute("sourceHeight"));

					//  Portrait source image.
					if(imgHeight > imgWidth)
					{
				        var ratio = imgWidth / imgHeight;
						// Set height to screen height.
						imgHeight = currHeight;
						// Scale width.
						imgWidth = currHeight * ratio;
					}
					// Landscape source image.
					else
					{
				        var ratio = imgHeight/imgWidth;
						// Set width to screen width.
						imgWidth = currWidth;
						// Scale height.
						imgHeight = currWidth * ratio;
					}

	        gImage.style["background-size"] =  imgWidth + "px " + imgHeight + "px";
				}
			}

			window.addEventListener("load", resizeFullscreen);
			window.addEventListener("resize", resizeFullscreen);
			window.addEventListener("focus", resizeFullscreen);
			
				
			//-------------------------------------------------------------------------
			// Toggle play/pause.
			//-------------------------------------------------------------------------
			function playPause()
			{
				log("playPause");
				var button = document.getElementById("playpause");
				if(gPlaying)
				{
					window.speechSynthesis.pause();
					gPlaying = false;
					button.setAttribute("class", "glyphicon glyphicon-play playback-controls");
				}
				
				else
				{
					window.speechSynthesis.resume();
					if(window.speechSynthesis.pending == false)
					{
						playNextChunk();
					}
					gPlaying = true;
					button.setAttribute("class", "glyphicon glyphicon-pause playback-controls");
				}
			}
	
			//-------------------------------------------------------------------------
			// Play the next chunk. Called when the current chunk completes playback.
			// To explicitly skip to the next chunk, call goNext().
			//-------------------------------------------------------------------------
			function playNextChunk()
			{
				if(gCurrChunk < gChunks.length && !gScrubbing)
				{
					gPlaying = true;
					++gCurrChunk;
					skipping = false;
			
					var text = gChunks[gCurrChunk];
					var msg = new SpeechSynthesisUtterance(text);

					var iOS = ( navigator.userAgent.match(/iPad|iPhone|iPod/g) ? true : false );
					if(iOS)
					{
						msg.rate = 0.5;
					}
					msg.chunkId = gCurrChunk;

					msg.addEventListener("start", function(){
						log("start");
						showMediaForChunk(this.chunkId);
					}.bind(msg));

					msg.addEventListener("end", function(){
						log("end");
						if(skipping != true)
						{
							playNextChunk();
						}
					}.bind(msg));

					// Hack to get speech synth to work reliably... seriously.
					// https://code.google.com/p/chromium/issues/detail?id=335907
					log(msg);
					gText.innerHTML = text;
					window.speechSynthesis.speak(msg);
				}
				var pct = parseInt((gCurrChunk/gChunks.length)*100);
				setScrubberPercentage(pct);
			}
			
			function manualPlay()
			{
				if(!gPlaying)
				{
					playNextChunk();
				}
			}
			</script>
  </head>

  <body onload="init()" onmousemove="onScrub(event)" onmouseup="onScrubEnd(event)">
					
		<!-- Cover Screen Begin -->
	  <div class="inner cover" id="cover">
	    <h1 class="cover-heading" style="padding-top:200px;padding-bottom:20px;margin:0;">The Primer</h1>
	    <p class="lead">Discover and explore all of human knowledge.</p>
	    <p class="lead">
				<form onsubmit="return doSearch()">
					<div class="row">
						<div class="col-xs-12 col-sm-10 col-lg-10">
							<input type="text" id="query" class="form-control" placeholder="Search" required autofocus>
						</div>
						<div class="col-xs-6 col-sm-2 col-lg-2">
							<input type="submit" value="Go" class="form-control">
						</div>
					</div>
				</form>
	    </p>
		<p class="lead">Don't know where to start? Try <span class="recommendation" onclick="populate(event)" id="randomRecommendation"></span>, <span class="recommendation" onclick="populate(event)">Paris</span>, <span class="recommendation" onclick="populate(event)">Disneyland</span>, <span class="recommendation" onclick="populate(event)">Oakland</span>, <span class="recommendation" onclick="populate(event)">World War I</span>, or enter your favorite topic. 
		</p>
	  </div>
		<!-- Cover Screen End -->

		<!-- Content Screen Begin -->
	  <div class="container-fluid header-info" id="content">
	      <div class="row">
	          <div class="col-md-10 text-left">
	              <h1 id="title"></h1>
	              <p id="currText"></p>
	          </div>
						<div class="col-md-2 text-right" style="font-size:25px;padding:10px;cursor:pointer"><span onclick="doHome()" class="glyphicon glyphicon-search"></div>
	      </div>
	      <!-- /.row -->
	  </div>
		<!-- Content Screen End -->


		<!-- Loading Screen Begin -->
	  <div class="inner cover" id="loading">
	    <h1 class="cover-heading" id="loadingHeading">Building Article</h1>
				<img class="center-block img-responsive" src="/assets/spinner.gif">
				<p class="lead" onclick="search(this.innerHTML)">Stand by, this could take several minutes.</p>
	  </div>
		<!-- Content Screen End -->


		<!-- Playback controls Begin -->
		<footer class="footer" id="playControls">
			<div class="col-lg-12 col-md-12 col-sm-12">
				<div class="row">
					<span id="debug"></span>
				</div>
				<div class="row caption-container">
					<span style="font-size:18px">learn more about</span> <span id="caption" article="" onclick="search(this.article)"></span>
				</div>
				<div class="row scrubber-bg">
					<div class="scrubber-progress" id="scrubberProgress"><span id="scrubberHandle" class="glyphicon glyphicon-record" onmousedown="onScrubStart()"></span></div>
				</div>

				<div class="row playback-controls-container">
					<div class="col-md-2 text-left">
						<span id="playpause" class="glyphicon glyphicon-pause playback-controls" onclick="playPause()"></span>
					</div>
					<div class="col-md-10" style="text-align:right">
						Content from <a href="https://www.wikipedia.org">Wikipedia</a>, the free encyclopedia.
					</div>
				</div>

			</div>
		</footer>
		<!-- Playback controls End -->

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
		<!-- Latest compiled and minified JavaScript -->
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <!-- <script src="../../assets/js/ie10-viewport-bug-workaround.js"></script> -->
		
  </body>
</html>
